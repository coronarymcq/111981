<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coronary Academic MCQs</title>
    <link rel="icon" href="icons/header-logo-32x32.png" type="image/x-icon" />
    <link rel="stylesheet" href="css/header04.css" />
    <link rel="stylesheet" href="css/sidebar01.css" />
    <link rel="stylesheet" href="css/Beta.css" />
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/home.css" />
    <link rel="stylesheet" href="css/socrates.css" />
    <link rel="stylesheet" href="css/contact.css" />
    <link rel="stylesheet" href="css/library.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400..800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <style>
      .arabic-font {
        font-family: "Baloo Bhaijaan 2", Arial, sans-serif;
      }
      .nav-button {
        background-color: transparent;
        border: none;
        cursor: pointer;
      }

      svg rect {
        transition: width 0.4s ease, y 0.4s ease;
      }
    </style>
    <script>
      const savedTheme = localStorage.getItem("theme");

      if (savedTheme) {
        document.documentElement.setAttribute("data-theme", savedTheme);
      }
    </script>
  </head>

  <body
    style="
      font-family: Nunito, Arial;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      scroll-behavior: smooth;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    "
  >
    <header class="header-container">
      <div class="left-section">
        <nav>
          <button
            class="nav-button"
            style="padding-left: 1px; padding-top: 2px"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 100 100"
              id="icon"
            >
              <rect y="40" width="100" height="12"></rect>
              <rect id="secondBar" y="70" width="70" height="12"></rect>
            </svg>
          </button>
        </nav>
        <div
          class="theme-toggle-container"
          style="padding-left: 5px; padding-top: 8px"
        >
          <button id="themeToggleBtn" onclick="toggleTheme()">
            <img id="themeIcon" src="icons/DMI.svg" alt="Theme Icon" />
          </button>
        </div>
      </div>
      <div class="right-section">
        <div id="auth-buttons" class="right-section">
          <a href="cont/011215071914/login01.html">
            <button
              class="login-button"
              style="margin-top: 8px; margin-right: 10px"
            >
              Account
              <i style="font-size: 17px; padding-left: 10px" class="fa"
                >&#xf007;</i
              >
            </button>
          </a>
        </div>

        <!--
         <a href="cont/01.signUp/signup.html">
            <button class="register-button">Sign Up</button>
          </a>-->

        <section class="logo-container">
          <img
            class="header-logo"
            id="main-logo"
            alt="Home Logo"
            style="margin-right: 4px; width: 53px; height: auto"
            src="icons/header-logo-2.webp"
          />
          <img
            class="header-logo hover-logo"
            id="hover-logo"
            alt="Home Logo"
            onclick="goHome();"
            src="icons/header-logo.webp"
            style="margin-right: 4px; width: 53px; height: auto"
          />
        </section>
      </div>
    </header>

    <nav class="side-bar-container" style="z-index: 9">
      <button class="nav-bar active" data-page="main" id="nav-bar1">
        Home
      </button>
      <button class="nav-bar" data-page="bau" id="nav-bar3">Socrates</button>

      <button class="nav-bar" data-page="library" id="nav-bar2">Library</button>
      <button class="nav-bar" data-page="contact" id="nav-bar4">
        About Us
      </button>
      <!--
      <button class="nav-bar5" data-page="help" id="nav-bar5">Help</button>
      -->
    </nav>

    <div class="main" id="mainContainer"></div>

    <!-- <footer class="end-margin" style="font-size: 30px">
      <p class="end-margin-text01">2024 - Coronary Academic MCQs.</p>
      <p class="end-margin-text02">
        Beta Version â€“ Work in Progress, meaning it's not fully ready and may
        change later.
      </p>
      <p class="end-margin-text03" style="display: block; line-height: 0px">
        This website has been developed by
        <a href="javascript:void(0);" onclick="copyToClipboard()"
          ><span style="font-weight: 900">Mo'men Allala</span></a
        >.
      </p>
    </footer> -->

    <p
      id="copyMessage"
      class="end-margin-text04"
      style="margin-bottom: 10px; margin-top: 20px"
    >
      Telegram Username '@mumenq' copied to clipboard!
    </p>
    <footer
      class="footer-bar"
      style="
        font-family: Nunito, Arial, sans-serif;
        width: 100%;
        background-color: var(--bg-color);
        color: var(--text-color);
        text-align: center;
        padding: 15px 15px;
        font-size: 13px;
        margin-top: 5px;
        box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.02);
      "
    >
      <button id="backToTopBtn" class="back-to-top" title="Back to the top">
        <i style="font-size: 19px; color: var(--lang-txt)" class="fas"
          >&#xf062;</i
        >
      </button>
      <span style="font-size: 10px"
        >Content shared on this website is intended for educational purposes
        only. All materials are provided free of charge and should never be sold
        or monetized.
        <a href="javascript:void(0);" onclick="copyToClipboard()"
          ><span class="dynamic-hover" style="font-weight: 700"
            >Contact Me</span
          ></a
        >.</span
      >
    </footer>
    <!-- Load jsPDF globally, before your dynamic JS loads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-arabic/dist/jspdf-arabic.umd.min.js"></script>

    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script>
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          if (document.querySelector(`script[src="${src}"]`)) {
            resolve();
            return;
          }
          const script = document.createElement("script");
          script.src = src;
          script.onload = () => resolve();
          script.onerror = () =>
            reject(new Error(`Failed to load script: ${src}`));
          document.body.appendChild(script);
        });
      }
    </script>
    <script src="script.js" defer></script>
    <script src="theme.js"></script>

    <script
      src="https://kit.fontawesome.com/607f9f57fe.js"
      crossorigin="anonymous"
    ></script>

    <script>
      function copyToClipboard() {
        const textToCopy = "@mumenq";
        const textarea = document.createElement("textarea");
        textarea.value = textToCopy;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        const message = document.getElementById("copyMessage");

        // Reset classes before showing
        message.classList.remove("show", "hide");
        message.style.visibility = "visible"; // Ensure it's visible before showing

        // Show message
        message.classList.add("show");

        // Remove the message after 2 seconds with smooth transition
        setTimeout(function () {
          message.classList.add("hide");
          message.classList.remove("show");
        }, 2000);

        // Ensure visibility is hidden after the transition ends
        setTimeout(function () {
          message.style.visibility = "hidden";
        }, 2500); // Wait for the complete transition duration before hiding
      }
    </script>

    <script type="module">
      console.log("[INDEX] Debug script running");

      const authButtonsDiv = document.getElementById("auth-buttons");
      if (authButtonsDiv) {
        console.log("[INDEX] Found auth-buttons div:", authButtonsDiv);
      } else {
        console.warn("[INDEX] auth-buttons div NOT found!");
      }

      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB6e_H-E7l6_x9GbOeJONZ515lsclyoogw",
        authDomain: "coronary-64f63.firebaseapp.com",
        projectId: "coronary-64f63",
        storageBucket: "coronary-64f63.firebasestorage.app",
        messagingSenderId: "110121771753",
        appId: "1:110121771753:web:bad6365385b0a38fa94678",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // Helper to dynamically load dashboard.js as a module and cache it
      async function loadDashboardScript() {
        try {
          if (!sessionStorage.getItem("dashboardScriptLoaded")) {
            console.log("[INDEX] Fetching and loading dashboard.js...");
            // Fetch dashboard.js text
            const response = await fetch("cont/00.dashboard/dashboard.js");
            if (!response.ok) throw new Error("Failed to fetch dashboard.js");
            const jsText = await response.text();

            // Create a new script element and evaluate the JS code as a module
            const blob = new Blob([jsText], { type: "text/javascript" });
            const url = URL.createObjectURL(blob);
            await import(url);
            URL.revokeObjectURL(url);

            sessionStorage.setItem("dashboardScriptLoaded", "true");
            console.log("[INDEX] dashboard.js loaded and applied successfully");
          } else {
            console.log(
              "[INDEX] dashboard.js already loaded from sessionStorage"
            );
          }
        } catch (error) {
          console.error("[INDEX] Error loading dashboard.js:", error);
        }
      }

      async function loadDashboard() {
        const mainContainer = document.querySelector(".main");
        if (!mainContainer) {
          console.error("[INDEX] Main container not found");
          return;
        }

        try {
          const response = await fetch("cont/00.dashboard/dashboard.html");
          if (!response.ok) throw new Error("Failed to load dashboard.html");
          const html = await response.text();

          mainContainer.innerHTML = html;
          console.log("[INDEX] Dashboard HTML loaded successfully");

          await loadDashboardScript();

          // If your dashboard.js exposes an init function, call it here
          if (typeof window.initDashboard === "function") {
            window.initDashboard();
            console.log("[INDEX] initDashboard() called");
          }

          sessionStorage.setItem("currentPage", "dashboard"); // Save current page state
        } catch (err) {
          console.error("[INDEX] Error loading dashboard:", err);
        }
      }

      function loadDefaultPage() {
        return loadContent("main")
          .then(() => console.log("Default page loaded"))
          .catch((err) => {
            console.error("Failed to load default page:", err);
            const mainContainer = document.querySelector(".main");
            if (mainContainer) {
              mainContainer.innerHTML =
                "<p>Welcome! Please login to continue.</p>";
            }
          });
      }

      function restoreAccountButton() {
        console.log("[INDEX] restoreAccountButton called");
        if (!authButtonsDiv) {
          console.warn(
            "[INDEX] auth-buttons div NOT found in restoreAccountButton"
          );
          return;
        }
        authButtonsDiv.innerHTML = `
      <a href="cont/011215071914/login01.html">
        <button class="login-button" style="margin-top: 8px; margin-right: 10px">
          Account
          <i style="font-size: 17px; padding-left: 10px" class="fa">&#xf007;</i>
        </button>
      </a>
    `;
        console.log("[INDEX] Account button restored");
      }

      function updateAuthUI(user) {
        console.log("[INDEX] updateAuthUI called with user:", user);
        if (!authButtonsDiv) {
          console.warn("[INDEX] auth-buttons div NOT found in updateAuthUI");
          return;
        }

        if (user) {
          console.log("[INDEX] User logged in. Updating UI...");
          authButtonsDiv.innerHTML = "";

          const userBtn = document.createElement("button");
          const displayName = user.displayName || user.email || "Unknown User";
          console.log("[INDEX] Setting username button text to:", displayName);
          userBtn.textContent = displayName;
          userBtn.className = "login-button";
          userBtn.style.cursor = "pointer";
          userBtn.onclick = () => {
            console.log("[INDEX] Username button clicked");
            loadDashboard();
          };

          const logoutBtn = document.createElement("button");
          logoutBtn.textContent = "Logout";
          logoutBtn.className = "register-button";
          logoutBtn.onclick = () => {
            console.log("[INDEX] Logout clicked");
            signOut(auth)
              .then(() => {
                console.log("[INDEX] Signed out successfully");
                restoreAccountButton();
                loadDefaultPage();
              })
              .catch((err) => {
                console.error("[INDEX] Sign out error:", err);
              });
          };

          authButtonsDiv.appendChild(userBtn);
          authButtonsDiv.appendChild(logoutBtn);
          console.log("[INDEX] User and logout buttons appended");
        } else {
          console.log("[INDEX] No user logged in, restoring Account button");
          restoreAccountButton();
          loadDefaultPage();
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            updateAuthUI(user);

            // Load saved page from sessionStorage or default to main
            const savedPage = sessionStorage.getItem("currentPage") || "main";

            if (savedPage === "dashboard") {
              loadDashboard();
            } else {
              loadContent(savedPage).catch((err) => {
                console.error("Failed to load saved page:", err);
                loadDefaultPage();
              });
            }
          } else {
            restoreAccountButton();

            // If no user, load saved page or default main page
            const savedPage = sessionStorage.getItem("currentPage") || "main";
            loadContent(savedPage).catch(() => loadDefaultPage());
          }
        });
      });
    </script>
  </body>
</html>
